<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>時間割アプリ</title>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
    import {
      getDatabase,
      ref,
      set,
      onValue,
      push,
      get
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA2M27QaMYPaWK5A1-b2wwvICq5KNcTZt8",
      authDomain: "planer-275c4.firebaseapp.com",
      databaseURL: "https://planer-275c4-default-rtdb.firebaseio.com",
      projectId: "planer-275c4",
      storageBucket: "planer-275c4.firebasestorage.app",
      messagingSenderId: "752551364905",
      appId: "1:752551364905:web:07673595f83cea2c618f38",
      measurementId: "G-12R593XP3D",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // 初期の時間割データ（タイトルのみ）
    const initialTimetableData = [
      ['', '', '', 'CS', '微分積分'],     // 1限
      ['Cプロ', '実験', '線形代数', '', 'ALC'],  // 2限
      ['中国語IA', '実験', '', '憲法IB', '電磁気学A'],  // 3限
      ['生命科学A', '実験', '', '中国語IB', '電磁気学A'],  // 4限
      ['', '実験', '力学A', '電生', '']   // 5限
    ];

    // 科目ごとの背景色を定義
    const subjectColors = {
      'CS': '#E3F2FD', // 爽やかな水色
      '微分積分': '#F3E5F5', // ラベンダー
      'Cプロ': '#FFF8E1', // クリームイエロー
      '実験': '#E0F7FA', // ターコイズ
      '線形代数': '#F1F8E9', // ミントグリーン
      '中国語IA': '#FCE4EC', // ピンク
      '中国語IB': '#FCE4EC', // ピンク
      '憲法IB': '#EDE7F6', // ライトパープル
      '電磁気学A': '#FFF3E0', // アプリコット
      '電生': '#E8F5E9', // セージグリーン
      '生命科学A': '#E1F5FE', // スカイブルー
      '力学A': '#F3E5F5', // ラベンダー
      'ALC': '#E8EAF6'  // ライトブルー
    };

    // 時間割データを初期化する関数
    function initializeTimetable() {
      const timetableRef = ref(db, "tabler/timetable");
      get(timetableRef).then((snapshot) => {
        if (!snapshot.exists()) {
          set(timetableRef, initialTimetableData);
        }
      });
    }

    // 時間割データを読み込む関数
    function loadTimetable() {
      const timetableRef = ref(db, "tabler/timetable");
      onValue(timetableRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          generateTimetable(data);
        }
      });
    }

    // タスクを保存する関数
    function saveTask(period, day, title, taskData) {
      const tasksRef = ref(db, "tabler/tasks");
      const newTaskRef = push(tasksRef);
      set(newTaskRef, {
        period: period,
        day: day,
        title: title,
        content: taskData.content,
        dueDate: taskData.dueDate,
        items: taskData.items,
        level: taskData.level,
        taskType: taskData.taskType,
        createdAt: Date.now()
      });
    }

    // タスクを読み込む関数
    function loadTasks() {
      const tasksRef = ref(db, "tabler/tasks");
      onValue(tasksRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          window.tasks = data; // グローバルに保存
          displayTasks(data);
          updateTaskNumbers(data);
        }
      });
    }

    // タスク数を計算して更新する関数
    function updateTaskNumbers(tasks) {
      const taskCounts = {};
      const earliestDueDates = {};
      
      // タスク数を集計（完了していないタスクのみ）
      Object.values(tasks).forEach(task => {
        if (!task.completed) {
          const key = `${task.period}_${task.day}_${task.title}`;
          taskCounts[key] = (taskCounts[key] || 0) + 1;
          
          // 最も早い期限を記録
          if (!earliestDueDates[key] || new Date(task.dueDate) < new Date(earliestDueDates[key])) {
            earliestDueDates[key] = task.dueDate;
          }
        }
      });

      // 時間割の各セルのタスク数を更新
      const cells = document.querySelectorAll('.cell:not(.header):not(.time)');
      cells.forEach(cell => {
        const title = cell.querySelector('.title')?.textContent;
        if (title) {
          const period = cell.getAttribute('data-period');
          const day = cell.getAttribute('data-day');
          const key = `${period}_${day}_${title}`;
          const count = taskCounts[key] || 0;

          // 既存の数値表示を削除
          const existingCircle = cell.querySelector('.number-circle');
          if (existingCircle) {
            existingCircle.remove();
          }

          // タスク数が0より大きい場合のみ表示
          if (count > 0) {
            const numberCircle = document.createElement('div');
            numberCircle.className = 'number-circle';
            numberCircle.textContent = count;
            
            // 期限に応じて色を設定
            const dueDate = earliestDueDates[key];
            if (dueDate) {
              const today = new Date();
              today.setHours(0, 0, 0, 0);
              const taskDate = new Date(dueDate);
              taskDate.setHours(0, 0, 0, 0);
              const weekLater = new Date(today);
              weekLater.setDate(weekLater.getDate() + 7);

              if (taskDate < today) {
                numberCircle.classList.add('due-date-overdue');
              } else if (taskDate.getTime() === today.getTime()) {
                numberCircle.classList.add('due-date-today');
              } else if (taskDate.getTime() === new Date(today.getTime() + 86400000).getTime()) {
                numberCircle.classList.add('due-date-tomorrow');
              } else if (taskDate <= weekLater) {
                numberCircle.classList.add('due-date-week');
              } else {
                numberCircle.classList.add('due-date-future');
              }
            }

            numberCircle.addEventListener('click', (e) => {
              e.stopPropagation();
              showTaskPopup(period, day, title);
            });
            cell.appendChild(numberCircle);
          }
        }
      });
    }

    // 時間割を生成する関数
    function generateTimetable(timetableData) {
      const timetable = document.getElementById('timetable');
      timetable.innerHTML = ''; // 既存の内容をクリア

      // ヘッダーを追加
      const days = ['月', '火', '水', '木', '金'];
      const headerCell = document.createElement('div');
      headerCell.className = 'cell header';
      timetable.appendChild(headerCell);

      // 現在の曜日と時間を取得
      const now = new Date();
      const currentDay = ['日', '月', '火', '水', '木', '金', '土'][now.getDay()];
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentTime = currentHour * 60 + currentMinute;

      days.forEach(day => {
        const cell = document.createElement('div');
        cell.className = 'cell header';
        if (day === currentDay) {
          cell.classList.add('current-day-header');
        }
        cell.textContent = day;
        timetable.appendChild(cell);
      });

      const periods = [
        { name: '1限', time: '8:50-10:30' },
        { name: '2限', time: '10:40-12:20' },
        { name: '3限', time: '13:10-14:50' },
        { name: '4限', time: '15:50-16:45' },
        { name: '5限', time: '17:00-18:40' }
      ];

      // 各限の時間範囲を分に変換
      const periodTimes = periods.map(period => {
        const [start, end] = period.time.split('-');
        const [startHour, startMinute] = start.split(':').map(Number);
        const [endHour, endMinute] = end.split(':').map(Number);
        return {
          start: startHour * 60 + startMinute,
          end: endHour * 60 + endMinute
        };
      });

      periods.forEach((period, periodIndex) => {
        // 時間ラベル
        const timeCell = document.createElement('div');
        timeCell.className = 'cell time';
        const periodName = document.createElement('div');
        periodName.className = 'period-name';
        periodName.textContent = period.name;
        const periodTime = document.createElement('div');
        periodTime.className = 'period-time';
        periodTime.textContent = period.time;
        timeCell.appendChild(periodName);
        timeCell.appendChild(periodTime);
        timetable.appendChild(timeCell);

        // 各曜日のセル
        days.forEach((day, dayIndex) => {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.setAttribute('data-period', period.name);
          cell.setAttribute('data-day', day);
          
          // 現在の曜日と時間に基づいてクラスを追加
          if (day === currentDay) {
            const periodTime = periodTimes[periodIndex];
            if (currentTime >= periodTime.start && currentTime <= periodTime.end) {
              cell.classList.add('current-period');
            }
          }
          
          const title = document.createElement('div');
          title.className = 'title';
          const subjectName = timetableData[periodIndex][dayIndex];
          title.textContent = subjectName;
          
          // 科目に応じた背景色を設定
          if (subjectName && subjectColors[subjectName]) {
            cell.style.backgroundColor = subjectColors[subjectName];
          }
          
          cell.appendChild(title);

          // タイトルが存在する場合のみクリックイベントを追加
          if (subjectName) {
            cell.addEventListener('click', () => {
              showTaskModal(period.name, day, subjectName);
            });
          }
          
          timetable.appendChild(cell);
        });
      });
    }

    // 日付を設定する関数
    function setDate(type) {
      const modalSubtitle = document.getElementById('modalSubtitle').textContent;
      const [period, day] = modalSubtitle.split(' ');
      
      // 曜日を数値に変換（月=1, 火=2, ..., 金=5）
      const dayMap = { '月': 1, '火': 2, '水': 3, '木': 4, '金': 5 };
      const subjectDay = dayMap[day];
      
      // 現在の日付を日本時間で取得
      const today = new Date();
      const jstToday = new Date(today.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
      const currentDay = jstToday.getDay(); // 0=日曜, 1=月曜, ..., 6=土曜
      
      // 次の授業日までの日数を計算
      let daysUntilNextClass;
      if (currentDay === 0) { // 日曜日の場合
        daysUntilNextClass = subjectDay;
      } else if (currentDay === 6) { // 土曜日の場合
        daysUntilNextClass = subjectDay + 1;
      } else {
        daysUntilNextClass = subjectDay - currentDay;
      }
      
      // 期限の日付を計算
      const deadline = new Date(jstToday);
      switch (type) {
        case 'previous':
          // 前日: 授業日の前日
          deadline.setDate(jstToday.getDate() + daysUntilNextClass - 1);
          break;
        case 'current':
          // 当日: 授業日
          deadline.setDate(jstToday.getDate() + daysUntilNextClass);
          break;
        case 'next':
          // 後日: 授業日の翌日
          deadline.setDate(jstToday.getDate() + daysUntilNextClass + 1);
          break;
        case 'nextWeek':
          // 次週: 来週の授業日の前日
          deadline.setDate(jstToday.getDate() + daysUntilNextClass + 6);
          break;
      }
      
      // 日付をYYYY-MM-DD形式に変換（日本時間）
      const year = deadline.getFullYear();
      const month = String(deadline.getMonth() + 1).padStart(2, '0');
      const date = String(deadline.getDate()).padStart(2, '0');
      const formattedDate = `${year}-${month}-${date}`;
      
      // 日付入力フィールドに設定
      document.getElementById('taskDate').value = formattedDate;
    }

    // モーダルを表示する関数
    function showTaskModal(period, day, title) {
      const modal = document.getElementById('taskModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');

      modalTitle.textContent = title;
      modalSubtitle.textContent = `${period} ${day}`;
      modal.style.display = 'block';

      // デフォルトで次週を選択
      setDate('nextWeek');
    }

    // フォーム送信時の処理
    document.getElementById('taskForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const taskContent = document.getElementById('taskContent').value;
      const selectedTaskType = document.querySelector('.task-type-btn.active')?.dataset.type;
      
      const taskData = {
        content: taskContent || (selectedTaskType ? selectedTaskType : '演習課題'),
        dueDate: document.getElementById('taskDate').value,
        items: Array.from(document.getElementById('taskItems').selectedOptions).map(option => option.value),
        level: document.getElementById('taskLevel').value,
        taskType: taskContent ? null : selectedTaskType
      };

      const modalTitle = document.getElementById('modalTitle').textContent;
      const modalSubtitle = document.getElementById('modalSubtitle').textContent;
      const [period, day] = modalSubtitle.split(' ');

      saveTask(period, day, modalTitle, taskData);
      
      document.getElementById('taskModal').style.display = 'none';
      this.reset();
      // デフォルトで演習課題を選択状態に
      document.querySelector('[data-type="演習課題"]').classList.add('active');
    });

    // モーダル外クリックで閉じる
    window.addEventListener('click', function(e) {
      const modal = document.getElementById('taskModal');
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
      initializeTimetable();
      loadTimetable();
      loadTasks();
    });

    // グローバルスコープに関数を公開
    window.setDate = setDate;

    // タスクの完了状態を更新する関数
    function updateTaskCompletion(taskId, completed) {
      const taskRef = ref(db, `tabler/tasks/${taskId}`);
      set(taskRef, {
        ...tasks[taskId],
        completed: completed,
        completedAt: completed ? Date.now() : null
      });
    }

    // タスク一覧を表示する関数
    function displayTasks(tasks) {
      const activeTasksContainer = document.getElementById('active-tasks');
      const completedTasksContainer = document.getElementById('completed-tasks');
      activeTasksContainer.innerHTML = '';
      completedTasksContainer.innerHTML = '';

      // タスクを期限順にソート
      const sortedTasks = Object.entries(tasks).sort(([, a], [, b]) => {
        return new Date(a.dueDate) - new Date(b.dueDate);
      });

      sortedTasks.forEach(([taskId, task]) => {
        const taskElement = createTaskElement(taskId, task);
        if (task.completed) {
          completedTasksContainer.appendChild(taskElement);
        } else {
          activeTasksContainer.appendChild(taskElement);
        }
      });
    }

    // タスク要素を作成する関数
    function createTaskElement(taskId, task) {
      const div = document.createElement('div');
      div.className = 'task-item';
      if (task.completed) {
        div.classList.add('completed');
      }

      // 課題タイプに応じたクラスを追加
      if (task.taskType) {
        div.classList.add(`task-type-${task.taskType}`);
      }

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'task-checkbox';
      checkbox.checked = task.completed || false;
      checkbox.addEventListener('change', () => {
        updateTaskCompletion(taskId, checkbox.checked);
      });

      const content = document.createElement('div');
      content.className = 'task-content';

      const title = document.createElement('div');
      title.className = 'task-title';
      title.textContent = `${task.title} (${task.period} ${task.day})`;

      const details = document.createElement('div');
      details.className = 'task-details';
      details.textContent = task.content || '';

      const meta = document.createElement('div');
      meta.className = 'task-meta';

      const dueDate = document.createElement('span');
      dueDate.className = 'due-date';
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const taskDate = new Date(task.dueDate);
      taskDate.setHours(0, 0, 0, 0);

      if (taskDate < today) {
        dueDate.classList.add('due-date-overdue');
      } else if (taskDate.getTime() === today.getTime()) {
        dueDate.classList.add('due-date-today');
      } else if (taskDate.getTime() === new Date(today.getTime() + 86400000).getTime()) {
        dueDate.classList.add('due-date-tomorrow');
      } else if (taskDate <= new Date(today.getTime() + 7 * 86400000)) {
        dueDate.classList.add('due-date-week');
      }

      dueDate.textContent = `期限: ${formatDueDate(task.dueDate)}`;

      const level = document.createElement('span');
      level.className = `task-level task-level-${task.level || 1}`;
      level.textContent = `レベル${task.level || 1}`;

      const items = document.createElement('div');
      items.className = 'task-items';
      if (task.items && Array.isArray(task.items)) {
        task.items.forEach(item => {
          const itemTag = document.createElement('span');
          itemTag.className = 'task-item-tag';
          itemTag.textContent = item;
          items.appendChild(itemTag);
        });
      }

      meta.appendChild(dueDate);
      meta.appendChild(level);
      content.appendChild(title);
      content.appendChild(details);
      content.appendChild(meta);
      content.appendChild(items);

      div.appendChild(checkbox);
      div.appendChild(content);

      return div;
    }

    // タブ切り替えの処理
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // タブのアクティブ状態を更新
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // コンテンツの表示を切り替え
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
      });
    });

    // 期限の表示形式を変更する関数
    function formatDueDate(date) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const taskDate = new Date(date);
      taskDate.setHours(0, 0, 0, 0);

      if (taskDate < today) {
        return '期限切れ';
      } else if (taskDate.getTime() === today.getTime()) {
        return '今日';
      } else if (taskDate.getTime() === tomorrow.getTime()) {
        return '明日';
      } else {
        const diffDays = Math.floor((taskDate - today) / (1000 * 60 * 60 * 24));
        return `${diffDays}日後`;
      }
    }

    // タスク一覧ポップアップを表示する関数
    function showTaskPopup(period, day, title) {
      const popup = document.createElement('div');
      popup.className = 'task-popup';
      popup.innerHTML = `
        <div class="task-popup-content">
          <div class="task-popup-header">
            <h2>${title}</h2>
            <p>${period} ${day}</p>
          </div>
          <div class="task-popup-list" id="taskPopupList"></div>
        </div>
      `;

      document.body.appendChild(popup);
      popup.style.display = 'block';

      // タスクを表示
      const taskList = document.getElementById('taskPopupList');
      const tasks = Object.entries(window.tasks || {})
        .filter(([, task]) => 
          !task.completed && 
          task.period === period && 
          task.day === day && 
          task.title === title
        )
        .sort(([, a], [, b]) => new Date(a.dueDate) - new Date(b.dueDate));

      tasks.forEach(([taskId, task]) => {
        const taskElement = createTaskElement(taskId, task);
        taskList.appendChild(taskElement);
      });

      // ポップアップ外クリックで閉じる
      popup.addEventListener('click', (e) => {
        if (e.target === popup) {
          popup.remove();
        }
      });
    }

    // 課題タイプボタンの切り替え
    document.querySelectorAll('.task-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.task-type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
  </script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #FAFAFA;
      color: #263238;
      animation: fadeIn 0.3s ease-out;
    }

    .timetable {
      display: grid;
      grid-template-columns: 60px repeat(5, 1fr);
      grid-template-rows: 40px repeat(5, 1fr);
      max-width: 1200px;
      margin: 20px auto;
      border: 1px solid #E0E0E0;
      aspect-ratio: 6 / 7;
      background: white;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      overflow: hidden;
      animation: scaleIn 0.4s ease-out;
    }

    .cell {
      border: 1px solid #E0E0E0;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white;
      padding: 8px;
      flex-direction: column;
      position: relative;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .cell:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1;
    }

    .title {
      font-weight: bold;
      margin-bottom: 4px;
      text-align: center;
      font-size: 0.8em;
      line-height: 1.2;
    }

    .number-circle {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 24px;
      height: 24px;
      background-color: #ff4444;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .number-circle:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .content {
      font-size: 0.9em;
      color: #666;
      text-align: center;
    }

    .header {
      background: linear-gradient(135deg, #1A237E, #283593);
      color: white;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .header::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
      );
      animation: shimmer 3s infinite linear;
    }

    .current-day-header {
      background: linear-gradient(135deg, #283593, #303F9F);
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .time {
      background: #F5F5F5;
      color: #455A64;
      font-weight: 500;
      border-right: 2px solid #E0E0E0;
    }

    .period-name {
      font-weight: bold;
      font-size: 0.9em;
      margin-bottom: 2px;
    }

    .period-time {
      font-size: 0.65em;
      color: #666;
      white-space: nowrap;
    }

    .current-day {
      background-color: #e3f2fd;
    }

    .current-period {
      border: 2px solid #1A237E;
      box-shadow: 0 0 15px rgba(26, 35, 126, 0.2);
      background: linear-gradient(135deg, #E8EAF6, #C5CAE9);
    }

    /* モーダル関連のスタイル */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.2em;
      color: #333;
    }

    .modal-header p {
      margin: 5px 0 0;
      color: #666;
      font-size: 0.9em;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-weight: bold;
    }

    .form-group input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .date-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .date-buttons button {
      padding: 8px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f8f8f8;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .date-buttons button:hover {
      background-color: #eee;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
    }

    .submit-button {
      width: 100%;
      padding: 10px;
      background-color: #2E7D32;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .submit-button:hover {
      background-color: #1B5E20;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
    }

    @media (min-width: 1024px) {
      .timetable {
        width: 90%;
        max-width: 1200px;
        height: calc(100vh - 200px);
        aspect-ratio: auto;
      }

      .cell {
        padding: 12px;
      }

      .title {
        font-size: 0.8em;
      }

      .number-circle {
        width: 32px;
        height: 32px;
        font-size: 14px;
        top: 4px;
        right: 4px;
      }

      /* タスク一覧のグリッドレイアウト */
      .task-list {
        display: block;
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      #active-tasks {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 40px;
      }

      .completed-tasks {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #eee;
      }

      #completed-tasks {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 40px;
      }

      .task-item {
        height: 100%;
        display: flex;
        align-items: flex-start;
        padding: 25px;
        margin-bottom: 0;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      }

      .task-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .task-details {
        flex-grow: 1;
        margin: 0;
        line-height: 1.5;
      }
    }

    @media (max-width: 1023px) {
      .timetable {
        width: 95vw;
        height: auto;
        aspect-ratio: 6 / 10;
      }

      .task-list {
        padding: 0 20px;
      }

      .cell:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }

      .task-item:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }

      .task-type-btn:active,
      .date-buttons button:active,
      .submit-button:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }

      .number-circle:active {
        transform: scale(0.95);
        transition: transform 0.1s;
      }
    }

    /* タブ関連のスタイル */
    .tabs {
      display: flex;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      justify-content: center;
      width: 100%;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      flex: 1;
      text-align: center;
      max-width: 200px;
    }

    .tab.active {
      border-bottom-color: #2E7D32;
      color: #2E7D32;
    }

    .tab:hover {
      background-color: rgba(245, 245, 245, 0.8);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* タスク一覧のスタイル */
    .task-list {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .task-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      animation: slideUp 0.3s ease-out;
    }

    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .task-checkbox {
      margin-right: 15px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-content {
      flex-grow: 1;
    }

    .task-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .task-details {
      color: #666;
      font-size: 0.9em;
    }

    .task-meta {
      display: flex;
      gap: 15px;
      margin-top: 5px;
      font-size: 0.8em;
      color: #888;
    }

    .task-level {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      background: #e0e0e0;
    }

    .task-level-1 {
      background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
      color: #2E7D32;
      font-weight: 500;
    }

    .task-level-2 {
      background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
      color: #EF6C00;
      font-weight: 500;
    }

    .task-level-3 {
      background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
      color: #C62828;
      font-weight: 500;
    }

    .completed-tasks {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #eee;
    }

    .completed-tasks .task-item {
      opacity: 0.7;
      text-decoration: line-through;
    }

    .task-items {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }

    .task-item-tag {
      background: #F5F5F5;
      color: #455A64;
      border: 1px solid #E0E0E0;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
    }

    /* 期限の色分けスタイル */
    .due-date {
      padding: 2px 8px;
      border-radius: 4px;
    }

    .due-date-today {
      background: linear-gradient(135deg, #E53935, #C62828);
      color: white;
      font-weight: 500;
    }

    .due-date-tomorrow {
      background: linear-gradient(135deg, #FF9800, #F57C00);
      color: white;
      font-weight: 500;
    }

    .due-date-week {
      background: linear-gradient(135deg, #1E88E5, #1565C0);
      color: white;
      font-weight: 500;
    }

    .due-date-overdue {
      background: linear-gradient(135deg, #D32F2F, #B71C1C);
      color: white;
      font-weight: 500;
    }

    .due-date-future {
      background: linear-gradient(135deg, #78909C, #546E7A);
      color: white;
      font-weight: 500;
    }

    /* タスク一覧ポップアップのスタイル */
    .task-popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      animation: fadeIn 0.2s ease-out;
    }

    .task-popup-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      /* animation: scaleIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); */
    }

    .task-popup-header {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .task-popup-header h2 {
      margin: 0;
      font-size: 1.2em;
      color: #333;
    }

    .task-popup-header p {
      margin: 5px 0 0;
      color: #666;
      font-size: 0.9em;
    }

    .task-popup-list {
      margin-top: 15px;
    }

    .task-popup-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .task-popup-item:last-child {
      border-bottom: none;
    }

    .task-type-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .task-type-btn {
      flex: 1;
      padding: 8px;
      border: 1px solid #E0E0E0;
      border-radius: 4px;
      background-color: #F5F5F5;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      color: #424242;
    }

    .task-type-btn.active {
      background-color: #2E7D32;
      border-color: #2E7D32;
      color: white;
      box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);
    }

    .task-type-演習課題 {
      border-left: 4px solid #43A047;
      background: linear-gradient(to right, #F1F8E9, white);
    }

    .task-type-予習課題 {
      border-left: 4px solid #1E88E5;
      background: linear-gradient(to right, #E3F2FD, white);
    }

    .task-type-追加演習 {
      border-left: 4px solid #FB8C00;
      background: linear-gradient(to right, #FFF3E0, white);
    }

    .number-circle.due-date-overdue {
      background: linear-gradient(135deg, #D32F2F, #B71C1C);
      box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
    }

    .number-circle.due-date-today {
      background: linear-gradient(135deg, #E53935, #C62828);
      box-shadow: 0 2px 8px rgba(229, 57, 53, 0.3);
    }

    .number-circle.due-date-tomorrow {
      background: linear-gradient(135deg, #FF9800, #F57C00);
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
    }

    .number-circle.due-date-week {
      background: linear-gradient(135deg, #1E88E5, #1565C0);
      box-shadow: 0 2px 8px rgba(30, 136, 229, 0.3);
    }

    .number-circle.due-date-future {
      background: linear-gradient(135deg, #78909C, #546E7A);
      box-shadow: 0 2px 8px rgba(120, 144, 156, 0.3);
    }

    /* モーダルのスタイルを更新 */
    .modal-content {
      background: white;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border-radius: 16px;
      border: 1px solid #E0E0E0;
    }

    .modal-header {
      background: linear-gradient(135deg, #1A237E, #283593);
      color: white;
      padding: 20px;
      border-radius: 16px 16px 0 0;
      margin: -20px -20px 20px -20px;
    }

    .modal-header h2 {
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .modal-header p {
      color: #E8EAF6;
    }

    .submit-button {
      background: linear-gradient(135deg, #43A047, #2E7D32);
      box-shadow: 0 4px 12px rgba(67, 160, 71, 0.3);
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .submit-button:hover {
      background: linear-gradient(135deg, #2E7D32, #1B5E20);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(67, 160, 71, 0.4);
    }

    /* タブの色を更新 */
    .tabs {
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border-bottom: 1px solid #E0E0E0;
    }

    .tab {
      color: #455A64;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .tab:hover {
      background: #F5F5F5;
      color: #1A237E;
    }

    .tab.active {
      border-bottom-color: #1A237E;
      color: #1A237E;
      font-weight: 600;
    }

    /* 完了したタスクのセクション */
    .completed-tasks {
      background: #F5F5F5;
      border-radius: 12px;
      padding: 20px;
      margin-top: 40px;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .completed-tasks h3 {
      color: #455A64;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .completed-tasks .task-item {
      opacity: 0.8;
      background: #FAFAFA;
    }

    /* フォーム要素のスタイル更新 */
    .form-group input[type="text"],
    .form-group select {
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      padding: 10px;
      transition: all 0.3s ease;
    }

    .form-group input[type="text"]:focus,
    .form-group select:focus {
      border-color: #1A237E;
      box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
      outline: none;
    }

    .date-buttons button {
      background: #F5F5F5;
      border: 1px solid #E0E0E0;
      color: #455A64;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .date-buttons button:hover {
      background: #EEEEEE;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* アニメーションの定義 */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* 基本アニメーション */
    body {
      animation: fadeIn 0.3s ease-out;
    }

    .timetable {
      animation: scaleIn 0.4s ease-out;
    }

    /* セルのアニメーション */
    .cell {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .cell:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1;
    }

    /* ヘッダーのアニメーション */
    .header {
      position: relative;
      overflow: hidden;
    }

    .header::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
      );
      animation: shimmer 3s infinite linear;
    }

    /* タスクカードのアニメーション */
    .task-item {
      animation: slideUp 0.3s ease-out;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* モーダルのアニメーション */
    .modal {
      animation: fadeIn 0.2s ease-out; /* アニメーション削除 */
    }

    /* .modal-content {
      animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* アニメーション削除 
    } */

    /* ボタンのアニメーション */
    .task-type-btn,
    .date-buttons button,
    .submit-button {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-type-btn:hover,
    .date-buttons button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .submit-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
    }

    タスク数バッジのアニメーション
    .number-circle {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .number-circle:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* タブのアニメーション */
    .tab {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; /* 下線アニメーションのため */
    }

    .tab::after {
      content: '';
      position: absolute;
      bottom: -1px; /* border-bottomを考慮 */
      left: 0;
      width: 0;
      height: 3px;
      background-color: #1A237E;
      transition: width 0.25s ease-out;
    }

    .tab.active::after {
      width: 100%;
    }

    .tab:hover {
      background-color: rgba(245, 245, 245, 0.8);
    }

    /* モバイル向けのタッチフィードバック */
    @media (max-width: 1023px) {
      .cell:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }

      .task-item:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }

      .task-type-btn:active,
      .date-buttons button:active,
      .submit-button:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }

      .number-circle:active {
        transform: scale(0.95);
        transition: transform 0.1s;
      }
    }

    /* 完了タスクのアニメーション */
    .task-item.completed {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-item.completed .task-content {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* タスクチェックボックスのアニメーション */
    .task-checkbox {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-checkbox:checked {
      animation: scaleIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 完了タスクセクションの見出し */
    .completed-tasks h3 {
      animation: slideUp 0.4s ease-out 0.1s backwards;
    }

    /* タスク詳細のアニメーション */
    .task-details,
    .task-meta,
    .task-items {
      animation: fadeIn 0.3s ease-out 0.15s backwards; 
    }
    
  </style>
</head>
<body>
  <!-- タブ -->
  <div class="tabs">
    <div class="tab active" data-tab="timetable">時間割</div>
    <div class="tab" data-tab="tasks">タスク</div>
  </div>

  <!-- 時間割タブ -->
  <div class="tab-content active" id="timetable-tab">
    <div class="timetable" id="timetable">
      <!-- 時間割の内容はJavaScriptで生成 -->
    </div>
  </div>

  <!-- タスクタブ -->
  <div class="tab-content" id="tasks-tab">
    <div class="task-list">
      <div id="active-tasks">
        <!-- 未完了タスクはここに表示 -->
      </div>
      <div class="completed-tasks">
        <h3>完了したタスク</h3>
        <div id="completed-tasks">
          <!-- 完了タスクはここに表示 -->
        </div>
      </div>
    </div>
  </div>

  <!-- タスク追加モーダル -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
        <p id="modalSubtitle"></p>
      </div>
      <form id="taskForm">
        <div class="form-group">
          <label>課題タイプ</label>
          <div class="task-type-buttons">
            <button type="button" class="task-type-btn active" data-type="演習課題">演習課題</button>
            <button type="button" class="task-type-btn" data-type="予習課題">予習課題</button>
            <button type="button" class="task-type-btn" data-type="追加演習">追加演習</button>
          </div>
        </div>
        <div class="form-group">
          <label for="taskContent">内容</label>
          <input type="text" id="taskContent">
        </div>
        <div class="form-group">
          <label>期限</label>
          <div class="date-buttons">
            <button type="button" onclick="setDate('previous')">前日</button>
            <button type="button" onclick="setDate('current')">当日</button>
            <button type="button" onclick="setDate('next')">後日</button>
            <button type="button" onclick="setDate('nextWeek')">次週</button>
          </div>
          <input type="date" id="taskDate" required>
        </div>
        <div class="form-group">
          <label for="taskItems">使用物</label>
          <select id="taskItems" multiple>
            <option value="pc">PC</option>
            <option value="notebook">ノート</option>
            <option value="textbook">教科書</option>
          </select>
        </div>
        <div class="form-group">
          <label for="taskLevel">レベル</label>
          <select id="taskLevel" required>
            <option value="1">レベル1</option>
            <option value="2">レベル2</option>
            <option value="3">レベル3</option>
          </select>
        </div>
        <button type="submit" class="submit-button">追加</button>
      </form>
    </div>
  </div>
</body>
</html>
